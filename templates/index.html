{% extends "layout.html" %}
{% block title %}{% endblock %}

{% block main %}
{% if get_flashed_messages() %}
<header class="container">
    <div class="alert" role="alert">
        {{ get_flashed_messages() | join(" ") }}
    </div>
</header>
{% endif %}

<div class="container">
    <h1 class="page-heading">
        Buses in Campus
    </h1>
    <p class="section-desc">See how many buses are at each bus stop within the campus. In NIT Arunachal Pradesh, bus
        stops are at three locations- Hostels, Academic block and Library.</p>

    <div class="update-time">
        Last update: <time id="timestamp">{{ timestamp }}</time>
    </div>

    <div class="location-cards">
        <div class="card">
            <h2>Hostel</h2>
            <div>
                <p><span id="hostelCt">{{ hostel_count }}</span>
                    {% if hostel_count == 1 %}
                    bus
                    {% else %}
                    buses
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="card">
            <h2>Academic Block</h2>
            <div>
                <p><span id="acadCt">{{ acad_count }}</span>
                    {% if acad_count == 1 %}
                    bus
                    {% else %}
                    buses
                    {% endif %}
                </p>
            </div>
        </div>

        <div class="card">
            <h2>Library</h2>
            <div>
                <p><span id="libCt">{{ lib_count }}</span>
                    {% if lib_count == 1 %}
                    bus
                    {% else %}
                    buses
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
    <!-- 
    <div>
        <a href="/outside_campus">Click to view buses outside campus</a>
    </div> -->
</div>

<div class="container section">
    <h1 class="page-heading">
        Buses on map
    </h1>
    <p class="section-desc">See all the university buses' locations on the map at a Glance! The map updates in real time
        so you get the live location of each bus at one place.</p>

    <div id="map" class="bus-map">
        <div class="airavat-animate">
            <svg width="256" height="54" viewBox="0 0 256 54" fill="none" xmlns="http://www.w3.org/2000/svg">
                <g id="airavat-brand" clip-path="url(#clip0_1_2)">
                    <g id="Group">
                        <path id="road" d="M0 52.84H256" stroke="#8F8F8F" />
                        <g id="airavat">
                            <path id="Vector"
                                d="M44.7281 36.2L40.4081 25.064H26.3439L22.048 36.2H17.92L31.648 0.968002H35.3201L48.9521 36.2H44.7281ZM39.1841 21.4401L35.0799 10.376C34.9839 10.088 34.8239 9.61599 34.5999 8.95999C34.3921 8.30399 34.176 7.624 33.952 6.92C33.728 6.216 33.5439 5.64799 33.4001 5.21599C33.2401 5.87199 33.0639 6.52799 32.8719 7.18399C32.6961 7.82399 32.5199 8.424 32.3441 8.984C32.1679 9.528 32.0161 9.992 31.8881 10.376L27.712 21.4401H39.1841Z"
                                fill="#008000" />
                            <path id="Vector_2"
                                d="M215.256 36.2H211.152V4.712H200.112V1.112H226.248V4.712H215.256V36.2Z"
                                fill="#D2691E" />
                            <path id="Vector_3"
                                d="M162.424 1.112L149.824 36.2H145.72L133.12 1.112H137.392L145.6 24.2241C145.936 25.1521 146.232 26.0399 146.488 26.888C146.76 27.7359 147 28.552 147.208 29.3359C147.416 30.12 147.6 30.8801 147.76 31.6161C147.92 30.8801 148.104 30.12 148.312 29.3359C148.52 28.5359 148.76 27.7121 149.032 26.8639C149.304 25.9999 149.608 25.096 149.944 24.1519L158.104 1.112H162.424Z"
                                fill="#808080" />
                            <path id="Vector_4"
                                d="M193.208 36.2L188.888 25.064H174.824L170.528 36.2H166.4L180.128 0.968002H183.8L197.432 36.2H193.208ZM187.664 21.4401L183.56 10.376C183.464 10.088 183.304 9.61599 183.08 8.95999C182.872 8.30399 182.656 7.624 182.432 6.92C182.208 6.216 182.024 5.64799 181.88 5.21599C181.72 5.87199 181.544 6.52799 181.352 7.18399C181.176 7.82399 181 8.424 180.824 8.984C180.648 9.528 180.496 9.992 180.368 10.376L176.192 21.4401H187.664Z"
                                fill="#6495ED" />
                            <path id="Vector_5"
                                d="M80.8399 1.112C83.7199 1.112 86.0961 1.47199 87.968 2.19199C89.856 2.89599 91.264 3.976 92.192 5.432C93.12 6.888 93.5841 8.744 93.5841 10.9999C93.5841 12.8559 93.248 14.408 92.576 15.656C91.904 16.8879 91.0241 17.8881 89.9361 18.6561C88.8481 19.4241 87.6879 20.0159 86.4561 20.4319L96.0801 36.2H91.328L82.7361 21.5599H75.4401V36.2H71.36V1.112H80.8399ZM80.6001 4.63999H75.4401V18.1039H81.0081C83.872 18.1039 85.9761 17.5199 87.3201 16.3521C88.6799 15.1839 89.3601 13.4639 89.3601 11.1919C89.3601 8.808 88.64 7.11999 87.2 6.12799C85.7761 5.13599 83.5761 4.63999 80.6001 4.63999Z"
                                fill="#9932CC" />
                            <path id="Vector_6"
                                d="M126.648 36.2L122.328 25.064H108.264L103.968 36.2H99.84L113.568 0.968002H117.24L130.872 36.2H126.648ZM121.104 21.4401L117 10.376C116.904 10.088 116.744 9.61599 116.52 8.95999C116.312 8.30399 116.096 7.624 115.872 6.92C115.648 6.216 115.464 5.64799 115.32 5.21599C115.16 5.87199 114.984 6.52799 114.792 7.18399C114.616 7.82399 114.44 8.424 114.264 8.984C114.088 9.528 113.936 9.992 113.808 10.376L109.632 21.4401H121.104Z"
                                fill="#FF0000" />
                            <path id="Vector_7" d="M56 36.2V1.112H60.0801V36.2H56Z" fill="#FFA500" />
                        </g>
                        <g id="wheel2">
                            <path id="Vector_8"
                                d="M43.52 51.56C52.0031 51.56 58.88 44.6831 58.88 36.2C58.88 27.7169 52.0031 20.84 43.52 20.84C35.0369 20.84 28.16 27.7169 28.16 36.2C28.16 44.6831 35.0369 51.56 43.52 51.56Z"
                                fill="white" />
                            <path id="Vector_9"
                                d="M43.52 20.84C35.0505 20.84 28.16 27.7305 28.16 36.2C28.16 44.6695 35.0505 51.56 43.52 51.56C51.9895 51.56 58.88 44.6695 58.88 36.2C58.88 27.7305 51.9893 20.84 43.52 20.84ZM43.52 47.1094C37.4948 47.1094 32.6106 42.2252 32.6106 36.2C32.6106 30.1748 37.4948 25.2906 43.52 25.2906C49.545 25.2906 54.4294 30.1748 54.4294 36.2C54.4294 42.2252 49.545 47.1094 43.52 47.1094Z"
                                fill="black" />
                            <path id="Vector_10"
                                d="M43.52 26.7029C38.2833 26.7029 34.0229 30.9633 34.0229 36.2C34.0229 41.4367 38.2833 45.6971 43.52 45.6971C48.7567 45.6971 53.0171 41.4367 53.0171 36.2C53.0171 30.9633 48.7567 26.7029 43.52 26.7029ZM51.8008 35.5946H47.1928C47.0986 35.0122 46.8687 34.4751 46.537 34.0161L49.79 30.7628C50.932 32.0779 51.6672 33.7537 51.8008 35.5946ZM44.116 27.9184C45.9558 28.0495 47.6309 28.7819 48.9467 29.9208L45.6942 33.1733C45.2352 32.8415 44.6981 32.6117 44.116 32.5174V27.9184ZM42.924 27.9184V32.5174C42.3419 32.6117 41.8048 32.8415 41.3458 33.1733L38.0931 29.9208C39.4089 28.7821 41.0842 28.0495 42.924 27.9184ZM37.2495 30.7628L40.5028 34.0161C40.171 34.4751 39.9411 35.0122 39.8472 35.5943H35.2392C35.3725 33.7537 36.108 32.0779 37.2495 30.7628ZM35.2376 36.7862H39.8472C39.9411 37.3684 40.1713 37.9055 40.503 38.3645L37.2408 41.6267C36.1001 40.3085 35.3669 38.6297 35.2376 36.7862ZM42.924 44.4816C41.0793 44.35 39.4002 43.614 38.0828 42.4702L41.3458 39.2072C41.8048 39.539 42.3419 39.7689 42.924 39.8631V44.4816ZM42.924 38.6371V38.6458C42.667 38.5834 42.4256 38.4817 42.2057 38.3473L42.2113 38.3414C41.8673 38.1318 41.5785 37.8428 41.3686 37.4987L41.363 37.5043C41.2286 37.2844 41.1269 37.0433 41.0645 36.786H41.0732C41.0266 36.5948 40.9994 36.3958 40.9994 36.19C40.9994 35.9844 41.0268 35.7855 41.0732 35.5943H41.0645C41.1269 35.3373 41.2286 35.0959 41.363 34.876L41.3686 34.8816C41.5785 34.5375 41.8675 34.2485 42.2113 34.0388L42.2057 34.0332C42.4256 33.8988 42.667 33.7969 42.924 33.7347V33.7434C43.1155 33.6968 43.3142 33.6694 43.52 33.6694C43.7258 33.6694 43.9247 33.6968 44.116 33.7434V33.7347C44.3733 33.7972 44.6144 33.8986 44.8343 34.033L44.8287 34.0388C45.1727 34.2485 45.4618 34.5375 45.6714 34.8813L45.6771 34.876C45.8115 35.0959 45.9131 35.3373 45.9756 35.5943H45.9671C46.0134 35.7855 46.0408 35.9845 46.0408 36.1903C46.0408 36.3958 46.0134 36.5948 45.9671 36.786H45.9756C45.9131 37.0433 45.8117 37.2847 45.6771 37.5046L45.6714 37.4989C45.4618 37.843 45.1725 38.132 44.8287 38.3417L44.8343 38.3473C44.6144 38.4817 44.3733 38.5834 44.116 38.6458V38.6371C43.9247 38.6837 43.7258 38.7111 43.52 38.7111C43.3142 38.7111 43.1155 38.6837 42.924 38.6371ZM44.116 44.4816V39.8631C44.6981 39.7689 45.2352 39.539 45.6942 39.2075L48.9569 42.4702C47.6396 43.614 45.9607 44.35 44.116 44.4816ZM49.7992 41.6267L46.537 38.3647C46.8687 37.9057 47.0986 37.3686 47.1928 36.7862H51.8024C51.6728 38.6297 50.9399 40.3085 49.7992 41.6267Z"
                                fill="black" />
                        </g>
                        <g id="wheel1">
                            <path id="Vector_11"
                                d="M171.52 51.56C180.003 51.56 186.88 44.6831 186.88 36.2C186.88 27.7169 180.003 20.84 171.52 20.84C163.037 20.84 156.16 27.7169 156.16 36.2C156.16 44.6831 163.037 51.56 171.52 51.56Z"
                                fill="white" />
                            <path id="Vector_12"
                                d="M171.52 20.84C163.05 20.84 156.16 27.7305 156.16 36.2C156.16 44.6695 163.05 51.56 171.52 51.56C179.99 51.56 186.88 44.6695 186.88 36.2C186.88 27.7305 179.989 20.84 171.52 20.84ZM171.52 47.1094C165.495 47.1094 160.611 42.2252 160.611 36.2C160.611 30.1748 165.495 25.2906 171.52 25.2906C177.545 25.2906 182.429 30.1748 182.429 36.2C182.429 42.2252 177.545 47.1094 171.52 47.1094Z"
                                fill="black" />
                            <path id="Vector_13"
                                d="M171.52 26.7029C166.283 26.7029 162.023 30.9633 162.023 36.2C162.023 41.4367 166.283 45.6971 171.52 45.6971C176.757 45.6971 181.017 41.4367 181.017 36.2C181.017 30.9633 176.757 26.7029 171.52 26.7029ZM179.801 35.5946H175.193C175.099 35.0122 174.869 34.4751 174.537 34.0161L177.79 30.7628C178.932 32.0779 179.667 33.7537 179.801 35.5946ZM172.116 27.9184C173.956 28.0495 175.631 28.7819 176.947 29.9208L173.694 33.1733C173.235 32.8415 172.698 32.6117 172.116 32.5174V27.9184ZM170.924 27.9184V32.5174C170.342 32.6117 169.805 32.8415 169.346 33.1733L166.093 29.9208C167.409 28.7821 169.084 28.0495 170.924 27.9184ZM165.25 30.7628L168.503 34.0161C168.171 34.4751 167.941 35.0122 167.847 35.5943H163.239C163.373 33.7537 164.108 32.0779 165.25 30.7628ZM163.238 36.7862H167.847C167.941 37.3684 168.171 37.9055 168.503 38.3645L165.241 41.6267C164.1 40.3085 163.367 38.6297 163.238 36.7862ZM170.924 44.4816C169.079 44.35 167.4 43.614 166.083 42.4702L169.346 39.2072C169.805 39.539 170.342 39.7689 170.924 39.8631V44.4816ZM170.924 38.6371V38.6458C170.667 38.5834 170.426 38.4817 170.206 38.3473L170.211 38.3414C169.867 38.1318 169.579 37.8428 169.369 37.4987L169.363 37.5043C169.229 37.2844 169.127 37.0433 169.064 36.786H169.073C169.027 36.5948 168.999 36.3958 168.999 36.19C168.999 35.9844 169.027 35.7855 169.073 35.5943H169.064C169.127 35.3373 169.229 35.0959 169.363 34.876L169.369 34.8816C169.579 34.5375 169.868 34.2485 170.211 34.0388L170.206 34.0332C170.426 33.8988 170.667 33.7969 170.924 33.7347V33.7434C171.116 33.6968 171.314 33.6694 171.52 33.6694C171.726 33.6694 171.925 33.6968 172.116 33.7434V33.7347C172.373 33.7972 172.614 33.8986 172.834 34.033L172.829 34.0388C173.173 34.2485 173.462 34.5375 173.671 34.8813L173.677 34.876C173.811 35.0959 173.913 35.3373 173.976 35.5943H173.967C174.013 35.7855 174.041 35.9845 174.041 36.1903C174.041 36.3958 174.013 36.5948 173.967 36.786H173.976C173.913 37.0433 173.812 37.2847 173.677 37.5046L173.671 37.4989C173.462 37.843 173.172 38.132 172.829 38.3417L172.834 38.3473C172.614 38.4817 172.373 38.5834 172.116 38.6458V38.6371C171.925 38.6837 171.726 38.7111 171.52 38.7111C171.314 38.7111 171.116 38.6837 170.924 38.6371ZM172.116 44.4816V39.8631C172.698 39.7689 173.235 39.539 173.694 39.2075L176.957 42.4702C175.64 43.614 173.961 44.35 172.116 44.4816ZM177.799 41.6267L174.537 38.3647C174.869 37.9057 175.099 37.3686 175.193 36.7862H179.802C179.673 38.6297 178.94 40.3085 177.799 41.6267Z"
                                fill="black" />
                        </g>
                    </g>
                </g>
                <defs>
                    <clipPath id="clip0_1_2">
                        <rect width="256" height="54" fill="white" />
                    </clipPath>
                </defs>
            </svg>
            <p>Map loading...</p>
        </div>
    </div>
</div>

<script>
    var map = null;
    let counts = null;
    let timestamp = null;
    let coords = [];

    async function fetchUpdates() {
        const response = await fetch('/fetch_updates', {
            method: 'GET',
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            },
        });
        return response.json();
    }

    function initiateFetchUpdate() {
        fetchUpdates()
        setInterval(() => {
            fetchUpdates().then(res => {
                counts = res.counts
                timestamp = res.timestamp
                coords = res.coords
                document.getElementById('libCt').innerText = counts.lib;
                document.getElementById('acadCt').innerText = counts.acad;
                document.getElementById('hostelCt').innerText = counts.hostel;
                document.getElementById('timestamp').innerText = timestamp;

                UpdateMap();
            })
        }, 2000);
    }


    function InitMap() {
        map = new Microsoft.Maps.Map('#map', {
            credentials: 'AsMbs64J91tX8_k7WZfcLoAi5yMYGksCQ_iVoRp6qg205sV8DWA4pfkm4_BZ6nxf',
            center: new Microsoft.Maps.Location(27.0845657, 93.59637)
        });

        async function fetchCoords() {
            const response = await fetch('/get_coords', {
                method: 'GET',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
            })
            return response.json();
        }

        fetchUpdates().then(res => {
            coords = res.coords
            coords.forEach(pin => {
                console.log(pin)

                var location = new Microsoft.Maps.Location(pin.lat, pin.lng)
                var pin = new Microsoft.Maps.Pushpin(location, {
                    title: `${pin.name}`,
                    subTitle: `${pin.license_plate}`,
                    text: `${pin.id}`,
                    color: 'green'
                });
                map.entities.push(pin);
            })
        })
        initiateFetchUpdate();
    }

    function UpdateMap() {
        function UpdatePushPinPosition(pin) {
            var location = new Microsoft.Maps.Location(pin.lat, pin.lng)
            for (var i = map.entities.getLength() - 1; i >= 0; i--) {
                var pushpin = map.entities.get(i);
                if (pushpin instanceof Microsoft.Maps.Pushpin && pushpin.getText() == String(pin.id)) {
                    pushpin.setLocation(location);
                    return;
                }
            }
            var newPushpin = new Microsoft.Maps.Pushpin(location, {
                title: `${pin.name}`,
                subTitle: `${pin.license_plate}`,
                text: `${pin.id}`,
                color: 'green'
            });
            map.entities.push(newPushpin);
        }

        coords.forEach(pin => {
            UpdatePushPinPosition(pin)
        })
    }
</script>

<!-- bing maps api SDK -->
<script type='text/javascript' src='http://www.bing.com/api/maps/mapcontrol?callback=InitMap' async defer></script>

{% endblock %}