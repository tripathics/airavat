{% extends "layout.html" %}
{% block title %}{% endblock %}

{% block main %}
{% if get_flashed_messages() %}
<header class="container">
    <div class="alert" role="alert">
        {{ get_flashed_messages() | join(" ") }}
    </div>
</header>
{% endif %}

<div class="container">
    <h1 class="page-heading">
        Buses in Campus
    </h1>
    <p>See how many buses are at each bus stop within the campus. In NIT Arunachal Pradesh, bus stops are at three locations- Hostels, Academic block and Library.</p>

    <div class="update-time">
        Last update: <time id="timestamp">{{ timestamp }}</time>
    </div>

    <div class="location-cards">
        <div class="card">
            <h2>Hostel</h2>
            <div>
                <p><span id="hostelCt">{{ hostel_count }}</span> buses</p>
            </div>
        </div>

        <div class="card">
            <h2>Academic Block</h2>
            <div>
                <p><span id="acadCt">{{ acad_count }}</span> buses</p>
            </div>
        </div>

        <div class="card">
            <h2>Library</h2>
            <div>
                <p><span id="libCt">{{ lib_count }}</span> buses</p>
            </div>
        </div>
    </div>
    <!-- 
    <div>
        <a href="/outside_campus">Click to view buses outside campus</a>
    </div> -->
</div>

<div class="container section">
    <h1 class="page-heading">
        Buses on map
    </h1>
    <p>See all the university buses' locations on the map at a Glance! The map updates in real time so you get the live location of each bus at one place.</p>

    <div id="map" class="bus-map">
        Please wait...
    </div>
</div>

<script>
    var map = null;
    let counts = null;
    let timestamp = null;
    let coords = [];

    async function fetchUpdates() {
        const response = await fetch('/fetch_updates', {
            method: 'GET',
            cache: 'no-cache',
            headers: {
                'Content-Type': 'application/json'
            },
        });
        return response.json();
    }

    function initiateFetchUpdate() {
        fetchUpdates()
        setInterval(() => {
            fetchUpdates().then(res => {
                counts = res.counts
                timestamp = res.timestamp
                coords = res.coords
                document.getElementById('libCt').innerText = counts.lib;
                document.getElementById('acadCt').innerText = counts.acad;
                document.getElementById('hostelCt').innerText = counts.hostel;
                document.getElementById('timestamp').innerText = timestamp;

                UpdateMap();
            })
        }, 5000);
    }

    
    function InitMap() {
        map = new Microsoft.Maps.Map('#map', {
            credentials: 'AsMbs64J91tX8_k7WZfcLoAi5yMYGksCQ_iVoRp6qg205sV8DWA4pfkm4_BZ6nxf',
            center: new Microsoft.Maps.Location(27.0845657, 93.59637)
        });

        async function fetchCoords() {
            const response = await fetch('/get_coords', {
                method: 'GET',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
            })
            return response.json();
        }

        fetchUpdates().then(res => {
            coords = res.coords
            coords.forEach(pin => {
                console.log(pin)

                var location = new Microsoft.Maps.Location(pin.lat, pin.lng)
                var pin = new Microsoft.Maps.Pushpin(location, {
                    title: `${pin.name}`,
                    subTitle: `${pin.license_plate}`,
                    text: `${pin.id}`,
                    color: 'green'
                });
                map.entities.push(pin);
            })
        })
        initiateFetchUpdate();
    }

    function UpdateMap() {
        function UpdatePushPinPosition(pin) {
            var location = new Microsoft.Maps.Location(pin.lat, pin.lng)
            for (var i = map.entities.getLength() - 1; i >= 0; i--) {
                var pushpin = map.entities.get(i);
                if (pushpin instanceof Microsoft.Maps.Pushpin && pushpin.getText() == String(pin.id)) {
                    pushpin.setLocation(location);
                    return;
                }
            }
            var newPushpin = new Microsoft.Maps.Pushpin(location, {
                title: `${pin.name}`,
                subTitle: `${pin.license_plate}`,
                text: `${pin.id}`,
                color: 'green'
            });
            map.entities.push(newPushpin);
        }

        coords.forEach(pin => {
            UpdatePushPinPosition(pin)
        })
    }
</script>

<!-- bing maps api SDK -->
<script type='text/javascript' src='http://www.bing.com/api/maps/mapcontrol?callback=InitMap' async defer></script>

{% endblock %}